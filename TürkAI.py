import streamlit as st
import requests
from bs4 import BeautifulSoup
import datetime
import sqlite3
import hashlib
import urllib.parse
import re
import time
import math
import random
from fpdf import FPDF

# --- âš™ï¸ SÄ°STEM AYARLARI ---
st.set_page_config(page_title="TÃ¼rkAI Analiz Merkezi", page_icon="ğŸ‡¹ğŸ‡·", layout="wide")

# --- PDF OLUÅTURMA FONKSÄ°YONU (FIXED) ---
def create_pdf_safe():
    """GÃ¼venli PDF oluÅŸturma - FPDF ile"""
    pdf = FPDF()
    pdf.add_page()
    
    # TÃ¼rkÃ§e karakter desteÄŸi iÃ§in
    pdf.add_font('DejaVu', '', 'DejaVuSansCondensed.ttf', uni=True)
    pdf.set_font('DejaVu', '', 14)
    
    # Emoji ve Ã¶zel karakterleri temizleme
    def clean_text(text):
        # Emojileri kaldÄ±r
        emoji_pattern = re.compile("["
            u"\U0001F600-\U0001F64F"  # emoticons
            u"\U0001F300-\U0001F5FF"  # symbols & pictographs
            u"\U0001F680-\U0001F6FF"  # transport & map symbols
            u"\U0001F1E0-\U0001F1FF"  # flags (iOS)
            u"\u26a1\u26a0\u2705\u274c\u2b50"  # diÄŸer Ã¶zel karakterler
            "]+", flags=re.UNICODE)
        text = emoji_pattern.sub(r'', text)
        
        # TÃ¼rkÃ§e karakterleri dÃ¼zelt
        replacements = {
            'Ä°': 'I', 'Ä±': 'i', 'Å': 'S', 'ÅŸ': 's',
            'Ä': 'G', 'ÄŸ': 'g', 'Ãœ': 'U', 'Ã¼': 'u',
            'Ã–': 'O', 'Ã¶': 'o', 'Ã‡': 'C', 'Ã§': 'c'
        }
        for old, new in replacements.items():
            text = text.replace(old, new)
        
        return text
    
    # PDF baÅŸlÄ±ÄŸÄ±
    pdf.set_font('DejaVu', 'B', 16)
    pdf.cell(200, 10, txt="TURKAI ANALIZ RAPORU", ln=True, align='C')
    pdf.ln(10)
    
    pdf.set_font('DejaVu', '', 12)
    
    # Rapor iÃ§eriÄŸi
    if 'user' in st.session_state:
        user = clean_text(st.session_state.user)
    else:
        user = "Misafir"
    
    if 'konu' in st.session_state:
        konu = clean_text(st.session_state.konu)
    else:
        konu = "Belirsiz"
    
    if 'bilgi' in st.session_state and st.session_state.bilgi:
        bilgi = clean_text(st.session_state.bilgi)
    else:
        bilgi = "Icerik bulunamadi."
    
    # PDF iÃ§eriÄŸi
    content = f"""
KULLANICI: {user}
TARIH: {datetime.datetime.now().strftime('%d.%m.%Y %H:%M')}
KONU: {konu}

ANALIZ SONUCLARI:
{bilgi}

---
TurkAI Analiz Sistemi | {datetime.datetime.now().strftime('%Y')}
"""
    
    # PDF'e yaz
    pdf.multi_cell(0, 10, txt=content)
    
    # Bytes'a dÃ¶nÃ¼ÅŸtÃ¼r (latin-1 yerine binary)
    try:
        pdf_output = pdf.output(dest='S')
        # Latin-1 hata verirse, binary olarak dÃ¶ndÃ¼r
        return pdf_output.encode('latin-1', 'ignore')
    except:
        # Direkt bytes olarak dÃ¶ndÃ¼r
        return pdf.output(dest='S').encode('utf-8', 'ignore')

# Alternatif: Daha basit PDF oluÅŸturma
def create_simple_pdf():
    """Daha basit ve gÃ¼venli PDF"""
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    
    # ASCII karakterlere Ã§evir
    def to_ascii(text):
        if not text:
            return ""
        # Sadece ASCII karakterleri koru
        return ''.join(char for char in str(text) if ord(char) < 128)
    
    # BaÅŸlÄ±k
    pdf.set_font("Arial", 'B', 16)
    pdf.cell(200, 10, txt="TURKAI REPORT", ln=True, align='C')
    pdf.ln(5)
    
    # Bilgiler
    pdf.set_font("Arial", size=12)
    
    user = to_ascii(st.session_state.get('user', 'Guest'))
    konu = to_ascii(st.session_state.get('konu', 'No Topic'))
    tarih = datetime.datetime.now().strftime('%d.%m.%Y %H:%M')
    
    pdf.cell(200, 10, txt=f"User: {user}", ln=True)
    pdf.cell(200, 10, txt=f"Date: {tarih}", ln=True)
    pdf.cell(200, 10, txt=f"Topic: {konu}", ln=True)
    pdf.ln(10)
    
    # Ä°Ã§erik
    if 'bilgi' in st.session_state and st.session_state.bilgi:
        content = to_ascii(st.session_state.bilgi)
        # Uzun metni parÃ§alara bÃ¶l
        lines = content.split('\n')
        for line in lines[:50]:  # Ä°lk 50 satÄ±r
            if line.strip():
                pdf.multi_cell(0, 10, txt=line[:200])  # SatÄ±r baÅŸÄ±na 200 karakter
    
    pdf.ln(10)
    pdf.cell(200, 10, txt="Generated by TurkAI System", ln=True, align='C')
    
    # Output
    return pdf.output(dest='S').encode('latin-1')

# --- TÃœRKAI ANA KODU (KISALTILMIÅ) ---

# Tema CSS
st.markdown("""
<style>
.stApp { background-color: #ffffff; }
h1, h2, h3 { color: #cc0000 !important; }
.stButton > button {
    background-color: #cc0000 !important;
    color: white !important;
    border-radius: 10px;
}
</style>
""", unsafe_allow_html=True)

# Session state baÅŸlat
if 'user' not in st.session_state:
    st.session_state.user = None
if 'bilgi' not in st.session_state:
    st.session_state.bilgi = None
if 'konu' not in st.session_state:
    st.session_state.konu = ""

# Basit giriÅŸ sistemi
if not st.session_state.user:
    st.title("ğŸ‡¹ğŸ‡· TÃ¼rkAI - GiriÅŸ")
    
    # BoÅŸ label hatasÄ± iÃ§in dÃ¼zeltme
    auth_mode = st.radio("Ä°ÅŸlem SeÃ§in:", ["GiriÅŸ Yap", "KayÄ±t Ol"], horizontal=True)
    
    if auth_mode == "GiriÅŸ Yap":
        with st.form("login"):
            username = st.text_input("KullanÄ±cÄ± AdÄ±")
            password = st.text_input("Åifre", type="password")
            if st.form_submit_button("GiriÅŸ"):
                st.session_state.user = username or "Misafir"
                st.rerun()
    
    else:
        with st.form("register"):
            new_user = st.text_input("Yeni KullanÄ±cÄ±")
            new_pass = st.text_input("Yeni Åifre", type="password")
            if st.form_submit_button("KayÄ±t Ol"):
                st.session_state.user = new_user or "Misafir"
                st.rerun()
    
    # Misafir giriÅŸi
    if st.button("ğŸ‘¤ Misafir Olarak Devam Et"):
        st.session_state.user = "Misafir"
        st.rerun()
    
    st.stop()

# Ana panel
st.title(f"ğŸ‡¹ğŸ‡· HoÅŸ geldin, {st.session_state.user}!")

# Arama kutusu - BOÅ LABEL HATASI DÃœZELTÄ°LDÄ°
sorgu = st.text_input("Aranacak konuyu yazÄ±n:", placeholder="Ã–r: TÃ¼rk tarihi, Python, matematik...")

if st.button("ğŸ” AraÅŸtÄ±r") and sorgu:
    with st.spinner("AranÄ±yor..."):
        # Basit Wikipedia aramasÄ±
        try:
            url = f"https://tr.wikipedia.org/w/api.php?action=query&list=search&srsearch={sorgu}&format=json"
            response = requests.get(url, timeout=10)
            data = response.json()
            
            if data['query']['search']:
                title = data['query']['search'][0]['title']
                snippet = data['query']['search'][0]['snippet']
                
                # HTML etiketlerini temizle
                snippet = re.sub('<[^<]+?>', '', snippet)
                
                st.session_state.bilgi = f"ğŸ“š **{title}**\n\n{snippet}"
                st.session_state.konu = sorgu
                
                st.success("âœ… SonuÃ§ bulundu!")
            else:
                st.session_state.bilgi = "âŒ SonuÃ§ bulunamadÄ±."
                st.session_state.konu = sorgu
        except:
            st.session_state.bilgi = "âš ï¸ Arama sÄ±rasÄ±nda hata oluÅŸtu."
            st.session_state.konu = sorgu
    
    st.rerun()

# SonuÃ§larÄ± gÃ¶ster
if st.session_state.bilgi:
    st.markdown(f"### ğŸ“Š Analiz: {st.session_state.konu}")
    st.markdown(st.session_state.bilgi)
    
    # PDF butonu - HATA DÃœZELTÄ°LDÄ°
    col1, col2, col3 = st.columns(3)
    
    with col1:
        try:
            # create_pdf_safe() fonksiyonunu kullan
            pdf_data = create_simple_pdf()
            st.download_button(
                label="ğŸ“„ PDF Ä°ndir",
                data=pdf_data,
                file_name=f"turkai_{st.session_state.konu[:15]}.pdf",
                mime="application/pdf",
                use_container_width=True
            )
        except Exception as e:
            st.error(f"PDF hatasÄ±: {str(e)[:50]}")
            # Alternatif buton
            if st.button("ğŸ“„ Basit PDF OluÅŸtur", use_container_width=True):
                try:
                    # En basit PDF
                    pdf = FPDF()
                    pdf.add_page()
                    pdf.set_font("Arial", size=12)
                    pdf.cell(200, 10, txt="TurkAI Rapor", ln=True, align='C')
                    pdf.cell(200, 10, txt=f"Konu: {st.session_state.konu}", ln=True)
                    pdf_output = pdf.output(dest='S')
                    st.download_button(
                        label="ğŸ“„ Ä°ndir",
                        data=pdf_output.encode('latin-1'),
                        file_name="rapor.pdf",
                        mime="application/pdf"
                    )
                except:
                    st.error("PDF oluÅŸturulamadÄ±")
    
    with col2:
        if st.button("ğŸ”„ Yeniden Ara", use_container_width=True):
            st.session_state.bilgi = None
            st.rerun()
    
    with col3:
        if st.button("ğŸšª Ã‡Ä±kÄ±ÅŸ", use_container_width=True):
            st.session_state.user = None
            st.session_state.bilgi = None
            st.rerun()

# BoÅŸ sayfa iÃ§in
elif not st.session_state.bilgi:
    st.info("ğŸ” Bir konu araÅŸtÄ±rmak iÃ§in yukarÄ±ya yazÄ±n ve 'AraÅŸtÄ±r' butonuna basÄ±n.")
    
    # Ã–rnek aramalar
    col1, col2, col3 = st.columns(3)
    with col1:
        if st.button("TÃ¼rk Tarihi"):
            st.session_state.konu = "TÃ¼rk Tarihi"
            st.session_state.bilgi = "ğŸ“š **TÃ¼rk Tarihi**\n\nTÃ¼rkler, Orta Asya kÃ¶kenli bir halktÄ±r. Tarih boyunca birÃ§ok devlet kurmuÅŸlardÄ±r."
            st.rerun()
    with col2:
        if st.button("Python"):
            st.session_state.konu = "Python"
            st.session_state.bilgi = "ğŸ“š **Python**\n\nPython, yÃ¼ksek seviyeli bir programlama dilidir. Basit sÃ¶zdizimi ile bilinir."
            st.rerun()
    with col3:
        if st.button("Matematik"):
            st.session_state.konu = "Matematik"
            st.session_state.bilgi = "ğŸ“š **Matematik**\n\nMatematik, sayÄ±lar, yapÄ±lar, uzay ve deÄŸiÅŸim gibi konularÄ± inceleyen bilim dalÄ±dÄ±r."
            st.rerun()

# Basit sidebar
with st.sidebar:
    st.markdown(f"### ğŸ‘¤ {st.session_state.user}")
    
    if st.button("ğŸ”´ Ã‡Ä±kÄ±ÅŸ Yap"):
        for key in list(st.session_state.keys()):
            del st.session_state[key]
        st.rerun()
    
    st.markdown("---")
    st.markdown("### ğŸ“œ Son Aramalar")
    
    # Ã–rnek geÃ§miÅŸ
    if st.button("TÃ¼rk Tarihi"):
        st.session_state.konu = "TÃ¼rk Tarihi"
        st.session_state.bilgi = "ğŸ“š **TÃ¼rk Tarihi**\n\nTÃ¼rkler, Orta Asya kÃ¶kenli bir halktÄ±r."
        st.rerun()
    
    if st.button("Python Programlama"):
        st.session_state.konu = "Python"
        st.session_state.bilgi = "ğŸ“š **Python**\n\nPython programlama dili."
        st.rerun()
